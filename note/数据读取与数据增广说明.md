# RISurConv 项目数据读取与数据增广说明

## 一、数据加载器 (Data Loaders)

项目包含4个主要的数据加载器，位于 `data_utils/` 目录下：

### 1. ModelNetDataLoader (`data_utils/ModelNetDataLoader.py`)

**用途**: 加载 ModelNet10/40 数据集

**主要特性**:
- 支持 ModelNet10 和 ModelNet40 两种数据集
- 支持是否使用法向量 (`use_normals`)
- 支持均匀采样 (`use_uniform_sample`)，使用 FPS (Farthest Point Sampling)
- 数据预处理和缓存机制
- 如果数据没有法向量，会使用 LRA (Local Reference Axis) 计算法向量

**数据格式**:
- 输入: `.txt` 文件，包含点云坐标（可能包含法向量）
- 输出: `[N, 6]` 数组（前3维为坐标，后3维为法向量）

**关键方法**:
- `__init__()`: 初始化，支持数据预处理和缓存
- `_get_item()`: 获取单个样本，进行点云归一化
- `farthest_point_sample()`: 最远点采样
- `pc_normalize()`: 点云归一化（去中心化并缩放到单位球内）

**使用场景**: `train_classification_modelnet40.py`

---

### 2. ShapeNetDataLoader (`data_utils/ShapeNetDataLoader.py`)

**用途**: 加载 ShapeNet 数据集，用于部件分割任务

**主要特性**:
- 支持 ShapeNet 部件分割数据集
- 支持是否使用法向量通道 (`normal_channel`)
- 随机采样点云到指定数量
- 数据缓存机制（最多缓存20000个样本）

**数据格式**:
- 输入: `.txt` 文件，包含点云坐标、法向量和分割标签
- 输出: `(point_set, cls, seg)` 元组
  - `point_set`: `[npoints, 6]` 或 `[npoints, 3]`（取决于是否使用法向量）
  - `cls`: 类别标签
  - `seg`: 分割标签

**关键方法**:
- `__getitem__()`: 获取样本，进行归一化和随机采样
- `pc_normalize()`: 点云归一化

**使用场景**: `train_partseg.py`

---

### 3. FG3D_DataLoader (`data_utils/FG3D_DataLoader.py`)

**用途**: 加载 FG3D 数据集（包含 Airplane、Car、Chair 三个类别）

**主要特性**:
- 支持三个类别：airplane、car、chair
- 从 `.off` 格式的网格文件读取
- 使用 Open3D 进行网格采样（Poisson Disk Sampling）
- 支持从三角形网格提取法向量
- 数据预处理和缓存机制

**数据格式**:
- 输入: `.off` 格式的网格文件
- 输出: `[N, 6]` 数组（前3维为坐标，后3维为法向量）

**关键方法**:
- `__init__()`: 初始化，使用 Open3D 读取网格并采样点云
- `_get_item()`: 获取样本，进行归一化

**使用场景**: `train_classification_FG3D.py`

---

### 4. ScanObjectNNLoader (`data_utils/ScanObjectNNLoader.py`)

**用途**: 加载 ScanObjectNN 数据集

**主要特性**:
- 从 HDF5 文件读取数据
- 支持两种数据模式：普通模式和 hardest 模式
- 支持均匀采样（FPS）
- 使用 LRA 计算法向量

**数据格式**:
- 输入: HDF5 文件（`.h5`）
  - 训练集: `training_objectdataset.h5` 或 `training_objectdataset_augmentedrot_scale75.h5`
  - 测试集: `test_objectdataset.h5` 或 `test_objectdataset_augmentedrot_scale75.h5`
- 输出: `[N, 6]` 数组（前3维为坐标，后3维为法向量）

**关键方法**:
- `__init__()`: 初始化，从 HDF5 加载数据，计算法向量
- `__getitem__()`: 获取样本，训练时随机打乱点顺序

**使用场景**: `train_classification_scanobj.py`

---

## 二、数据增广 (Data Augmentation)

所有数据增广函数都定义在 `provider.py` 文件中。

### 1. 旋转增广

#### `rotate_point_cloud(batch_data)`
- **功能**: 沿 Y 轴随机旋转点云
- **输入**: `[B, N, 3]` 点云数据
- **输出**: `[B, N, 3]` 旋转后的点云
- **旋转轴**: Y 轴（垂直方向）
- **旋转角度**: 0 到 2π 随机

#### `rotate_point_cloud_z(batch_data)`
- **功能**: 沿 Z 轴随机旋转点云
- **输入**: `[B, N, 3]` 点云数据
- **输出**: `[B, N, 3]` 旋转后的点云
- **旋转轴**: Z 轴

#### `rotate_point_cloud_with_normal(batch_xyz_normal)`
- **功能**: 沿 Y 轴随机旋转点云和法向量
- **输入**: `[B, N, 6]` 点云数据（前3维为坐标，后3维为法向量）
- **输出**: `[B, N, 6]` 旋转后的点云和法向量
- **特点**: 同时旋转坐标和法向量，保持一致性

#### `rotate_perturbation_point_cloud(batch_data, angle_sigma=0.06, angle_clip=0.18)`
- **功能**: 对点云进行小角度随机扰动旋转
- **输入**: `[B, N, 3]` 点云数据
- **参数**:
  - `angle_sigma`: 角度标准差（默认 0.06）
  - `angle_clip`: 角度裁剪范围（默认 0.18）
- **输出**: `[B, N, 3]` 扰动后的点云
- **特点**: 在 X、Y、Z 三个轴上分别进行小角度旋转

#### `rotate_perturbation_point_cloud_with_normal(batch_data, angle_sigma=0.06, angle_clip=0.18)`
- **功能**: 对点云和法向量进行小角度随机扰动旋转
- **输入**: `[B, N, 6]` 点云数据（包含法向量）
- **输出**: `[B, N, 6]` 扰动后的点云和法向量

#### `rotate_point_cloud_with_normal_so3(batch_data)`
- **功能**: 在 SO(3) 群上进行随机旋转
- **输入**: `[B, N, 6]` 点云数据（包含法向量）
- **输出**: `[B, N, 6]` 旋转后的点云和法向量
- **特点**: 在三个轴上分别随机旋转，实现任意方向的旋转

#### `rotate_point_cloud_by_angle(batch_data, rotation_angle)`
- **功能**: 按指定角度旋转点云
- **输入**: 
  - `batch_data`: `[B, N, 3]` 点云数据
  - `rotation_angle`: 旋转角度（标量）
- **输出**: `[B, N, 3]` 旋转后的点云

#### `rotate_point_cloud_by_angle_with_normal(batch_data, rotation_angle)`
- **功能**: 按指定角度旋转点云和法向量
- **输入**: 
  - `batch_data`: `[B, N, 6]` 点云数据（包含法向量）
  - `rotation_angle`: 旋转角度（标量）
- **输出**: `[B, N, 6]` 旋转后的点云和法向量

---

### 2. 噪声增广

#### `jitter_point_cloud(batch_data, sigma=0.01, clip=0.05)`
- **功能**: 对点云添加随机噪声
- **输入**: `[B, N, 3]` 点云数据
- **参数**:
  - `sigma`: 噪声标准差（默认 0.01）
  - `clip`: 噪声裁剪范围（默认 0.05）
- **输出**: `[B, N, 3]` 添加噪声后的点云
- **特点**: 对每个点独立添加高斯噪声

---

### 3. 平移增广

#### `shift_point_cloud(batch_data, shift_range=0.1)`
- **功能**: 随机平移点云
- **输入**: `[B, N, 3]` 点云数据
- **参数**:
  - `shift_range`: 平移范围（默认 0.1）
- **输出**: `[B, N, 3]` 平移后的点云
- **特点**: 每个样本独立随机平移

---

### 4. 缩放增广

#### `random_scale_point_cloud(batch_data, scale_low=0.8, scale_high=1.25)`
- **功能**: 随机缩放点云
- **输入**: `[B, N, 3]` 点云数据
- **参数**:
  - `scale_low`: 最小缩放比例（默认 0.8）
  - `scale_high`: 最大缩放比例（默认 1.25）
- **输出**: `[B, N, 3]` 缩放后的点云
- **特点**: 每个样本独立随机缩放

---

### 5. 点丢弃增广

#### `random_point_dropout(batch_pc, max_dropout_ratio=0.875)`
- **功能**: 随机丢弃点云中的点
- **输入**: `[B, N, 3]` 点云数据
- **参数**:
  - `max_dropout_ratio`: 最大丢弃比例（默认 0.875，即最多丢弃 87.5% 的点）
- **输出**: `[B, N, 3]` 丢弃后的点云
- **特点**: 被丢弃的点会被设置为第一个点的坐标

---

### 6. 数据归一化

#### `normalize_data(batch_data)`
- **功能**: 归一化批次数据
- **输入**: `[B, N, C]` 数据
- **输出**: `[B, N, C]` 归一化后的数据
- **处理**: 每个样本独立归一化（去中心化并缩放到单位球内）

---

### 7. 数据打乱

#### `shuffle_points(batch_data)`
- **功能**: 打乱每个点云中点的顺序
- **输入**: `[B, N, C]` 数据
- **输出**: `[B, N, C]` 打乱后的数据
- **特点**: 整个批次使用相同的打乱顺序

#### `shuffle_data(data, labels)`
- **功能**: 打乱批次数据和标签
- **输入**: 
  - `data`: `[B, N, C]` 数据
  - `labels`: `[B]` 标签
- **输出**: 打乱后的数据和标签

#### `shuffle_data_seg(data, labels)`
- **功能**: 打乱分割任务的数据和标签
- **输入**: 
  - `data`: `[B, N, ...]` 数据
  - `labels`: `[B, ...]` 标签
- **输出**: 打乱后的数据、标签和索引

---

## 三、训练中的使用

### 1. ModelNet40 分类任务 (`train_classification_modelnet40.py`)

**训练时使用的增广**:
```python
points = provider.random_point_dropout(points)  # 随机点丢弃
points[:, :, 0:3] = provider.random_scale_point_cloud(points[:, :, 0:3])  # 随机缩放
points[:, :, 0:3] = provider.shift_point_cloud(points[:, :, 0:3])  # 随机平移
# 注释掉的旋转增广:
# points[:, :, 0:6] = provider.rotate_point_cloud_with_normal(points[:, :, 0:6])
```

**测试时**: 不使用任何增广

---

### 2. ShapeNet 部件分割任务 (`train_partseg.py`)

**训练时使用的增广**:
```python
points[:, :, 0:3] = provider.random_scale_point_cloud(points[:, :, 0:3])  # 随机缩放
points[:, :, 0:3] = provider.shift_point_cloud(points[:, :, 0:3])  # 随机平移
```

**测试时**: 不使用任何增广

---

### 3. ScanObjectNN 分类任务 (`train_classification_scanobj.py`)

**训练时**: 在数据加载器中随机打乱点的顺序（`__getitem__` 方法中）

**测试时**: 不使用任何增广

---

## 四、数据预处理流程

### 通用预处理步骤

1. **点云归一化**: 所有数据加载器都会对点云进行归一化
   - 去中心化：减去质心
   - 缩放：缩放到单位球内（除以最大距离）

2. **采样**: 
   - FPS (Farthest Point Sampling): 最远点采样，保证点云分布均匀
   - 随机采样: 随机选择指定数量的点
   - Poisson Disk Sampling: 用于网格数据（FG3D）

3. **法向量处理**:
   - 如果数据包含法向量，直接使用
   - 如果数据不包含法向量，使用 LRA (Local Reference Axis) 计算

---

## 五、数据格式总结

### 输入格式
- **ModelNet**: `.txt` 文件，CSV 格式
- **ShapeNet**: `.txt` 文件，包含坐标、法向量和分割标签
- **FG3D**: `.off` 网格文件
- **ScanObjectNN**: HDF5 文件（`.h5`）

### 输出格式
- **分类任务**: `[B, N, 6]` 或 `[B, N, 3]`（取决于是否使用法向量）
- **分割任务**: `(point_set, cls, seg)` 元组

### 点云维度
- **坐标**: 前3维 `[x, y, z]`
- **法向量**: 后3维 `[nx, ny, nz]`（如果使用）
- **完整点云**: `[N, 6]` 或 `[N, 3]`

---

## 六、注意事项

1. **数据缓存**: ModelNet 和 FG3D 数据加载器支持数据预处理和缓存，可以加速训练
2. **法向量一致性**: 使用旋转增广时，如果点云包含法向量，必须同时旋转法向量以保持一致性
3. **归一化时机**: 点云归一化在数据加载器中进行，增广操作在训练循环中进行
4. **采样方法**: FPS 采样可以保证点云分布更均匀，但计算成本更高
5. **增广顺序**: 通常先进行几何变换（旋转、缩放、平移），再进行噪声添加和点丢弃

